<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="import_portal" name="Import Portal" inherit_id="portal.portal_my_home" customize_show="True" priority="20">
    <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
        <t t-set="portal_client_category_enable" t-value="True"/>
    </xpath>
    <div id="portal_client_category" position="inside">
        <t t-call="portal.portal_docs_entry">
            <t t-set="icon" t-value="'data_fetcher_base/static/src/img/bag.svg'"/>
            <t t-set="title">Import Portal</t>
            <t t-set="url" t-value="'/my/imports'"/>
            <t t-set="text">Import data from Shopify/Salesforce</t>
            <t t-set="placeholder_count" t-value="'invoice_count'"/>
            <t t-set="config_card" t-value="True"/>
        </t>
    </div>
</template>

<template id="portal_import_breadcrumbs" name="Portal Import Breadcrumbs">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light px-3 py-2 rounded shadow-sm mb-4">
            <li class="breadcrumb-item">
                <a href="/my">My Account</a>
            </li>
            <li class="breadcrumb-item">
                <a href="/my/imports">Import History</a>
            </li>
            <li t-if="breadcrumb_label" class="breadcrumb-item active" aria-current="page">
                <t t-esc="breadcrumb_label"/>
            </li>
        </ol>
    </nav>
</template>

    <template id="portal_import_list" name="Import Logs List">
    <t t-call="portal.portal_layout">
    <t t-call="data_fetcher_base.portal_import_breadcrumbs">
    <t t-set="breadcrumb_label" t-value="False"/>
    </t>
        <t t-set="title">Import History</t>
        <div class="o_portal_wrap container my-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Previous Import Requests</h3>
                <a href="/my/imports/new" class="btn btn-primary">
                    <i class="fa fa-plus-circle me-1"></i> New Request
                </a>
            </div>

            <t t-if="logs">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Source</th>
                            <th>User</th>
                            <th>Database</th>
                            <th>Status</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr t-foreach="logs" t-as="log">
                            <td><t t-esc="log.transfer_date"/></td>
                            <td><t t-esc="log.source"/></td>
                            <td><t t-esc="log.db_user"/></td>
                            <td><t t-esc="log.db_name"/></td>
                            <td>
                                <span t-if="log.import_status == 'completed'" class="badge bg-success">Success</span>
                                <span t-if="log.import_status == 'failed'" class="badge bg-danger">Failed</span>
                                <span t-if="log.import_status == 'pending'" class="badge bg-secondary">Pending</span>
                                <span t-if="log.import_status == 'in_progress'" class="badge bg-info">In Progress</span>
                            </td>
                            <td><t t-esc="log.error_message or '-'"/></td>
                        </tr>
                    </tbody>
                </table>
            </t>
            <t t-else="">
                <div class="alert alert-info">No import history found.</div>
            </t>
        </div>
    </t>
</template>

<template id="portal_credentials_form_base" name="Data Fetcher Base Form">
    <t t-call="portal.portal_layout">
    <t t-call="data_fetcher_base.portal_import_breadcrumbs">
    <t t-set="breadcrumb_label" t-value="'New Request'"/>
</t>
        <t t-set="title">Data Fetcher</t>
        <div class="o_portal_wrap">
            <div class="container my-2">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fa fa-database me-2"></i> Odoo Import Tool
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="dynamic-credentials-form" method="post" action="/my/api/data_transfer" class="oe_website_form">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                            <!-- System Selector -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Select System</label>
                                <div class="ms-2" t-foreach="systems" t-as="sys">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" t-att-id="sys" name="system"
                                               t-att-value="sys" t-att-checked="sys_first"/>
                                        <label class="form-check-label" t-att-for="sys" t-esc="sys.capitalize()"/>
                                    </div>
                                </div>
                            </div>

                            <!-- Placeholder for service-specific credentials -->
                            <div id="external-credentials-placeholder" class="mb-4">
                                <t t-call="data_fetcher_base.credentials_placeholder"/>
                            </div>

                            <!-- Odoo Credentials -->
                            <h5 class="fw-bold mb-3">
                                <i class="fa fa-cogs me-2"></i> Odoo Credentials
                            </h5>
                            <div class="mb-3">
                                <label class="form-label">Odoo URL</label>
                                <input type="url" class="form-control" name="odoo_url" placeholder="https://odoo.yourdomain.com" required="1"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Odoo Database</label>
                                <input type="text" class="form-control" name="odoo_db" placeholder="demo_db" required="1"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Odoo Username</label>
                                <input type="text" class="form-control" name="odoo_username" placeholder="admin" required="1"/>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Odoo API Key</label>
                                <input type="password" class="form-control" name="odoo_api_key" required="1"/>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-upload me-1"></i>
                                    <span id="btn-text">Import</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- JS -->
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const radios = document.querySelectorAll('input[name="system"]');
            const form = document.getElementById('dynamic-credentials-form');
            const btn = form.querySelector('button[type="submit"]');
            const btnText = document.getElementById('btn-text');

            function updateFormAndFields() {
                const selected = document.querySelector('input[name="system"]:checked').value;
                document.querySelectorAll('[data-cred-block]').forEach(el => {
                    const match = el.getAttribute('data-cred-block') === selected;
                    el.style.display = match ? 'block' : 'none';
                    el.querySelectorAll('input').forEach(input => {
                        input.toggleAttribute('required', match);
                    });
                });
            }

            form.addEventListener('submit', function () {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Importing...';
            });

            radios.forEach(r => r.addEventListener('change', updateFormAndFields));
            updateFormAndFields();
        });
        </script>
    </t>
</template>

<template id="credentials_placeholder" name="External Credentials Placeholder">
    <!-- Empty base slot to be overridden -->
</template>


    <template id="portal_import_data_result" name="Import Data Result">
    <t t-call="web.html_container">
    <t t-call="data_fetcher_base.portal_import_breadcrumbs">
    <t t-set="breadcrumb_label" t-value="'Import Result'"/>
</t>

        <div class="oe_structure container mt-5">
            <div class="card rounded-lg text-center py-5">
                <div class="card-body">
                    <t t-if="error">
                        <!-- Error Cross -->
                        <div class="text-danger mb-4" style="font-size: 8rem;">
                            <i class="fa fa-times-circle"></i>
                        </div>
                        <h3 class="text-danger mb-4">Import Failed</h3>
                        <p class="text-muted" t-esc="error"/>
                    </t>
                    <t t-if="results">
                        <!-- Success Tick -->
                        <div class="text-success mb-4" style="font-size: 8rem;">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <h3 class="text-success mb-4">Import Successful</h3>
                        <p class="text-muted" t-esc="results"/>
                    </t>
                    
                    <div class="mt-4">
                        <a href="/my" class="btn btn-primary">Return to My Account</a>
                    </div>
                </div>
            </div>
        </div>
    </t>
</template>
</odoo>